---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header/Header.astro";
---

<Layout title="Parents Chat Community">
  <Header title="Padres Chat" />
  <div class="chat-container">
    <div class="main-chat">
      <div class="chat-messages" id="chat-messages">
        <div class="message system-message">
          <div class="message-content">
            Bienvenido a la comunidad de padres. Aqu√≠ puedes compartir tus experiencias y hacer preguntas a otros padres. Hay 5 padres conectados ahora mismo.
          </div>
        </div>
        <div class="message other-message">
          <div class="message-header">
            <span class="user-name">üë©‚Äçüë¶ Mar√≠a P.</span>
            <span class="timestamp">hace 5 min</span>
          </div>
          <div class="message-content">
            Hola a todos! Mi beb√© de 3 meses no quiere dormir m√°s de 2 horas seguidas. Estoy agotada üò¥ ¬øAlg√∫n consejo?
          </div>
        </div>
        <div class="message other-message">
          <div class="message-header">
            <span class="user-name">üë®‚Äçüëß Carlos M.</span>
            <span class="timestamp">hace 4 min</span>
          </div>
          <div class="message-content">
            @Mar√≠a Te entiendo perfectamente. Con mi hija pasamos por lo mismo. Lo que nos funcion√≥ fue establecer una rutina muy estricta antes de dormir: ba√±o, masaje, cuento y a la cama siempre a la misma hora.
          </div>
        </div>
        <div class="message other-message">
          <div class="message-header">
            <span class="user-name">üë©‚Äçüëß‚Äçüë¶ Laura S.</span>
            <span class="timestamp">hace 3 min</span>
          </div>
          <div class="message-content">
            ¬øAlguien tiene experiencia con la alimentaci√≥n complementaria? Mi beb√© cumple 6 meses la pr√≥xima semana y no s√© si empezar con frutas o cereales.
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="input-group">
          <input
            type="text"
            id="user-input"
            placeholder="Comparte tu experiencia o pregunta..."
          />
          <button id="send-btn">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style lang="css">
  .chat-container {
    display: flex;
    height: 90%;
    max-width: 100%;
    margin: 0;
    overflow: hidden;
  }

  .main-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: calc(100% - 250px);
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .message {
    max-width: 85%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    display: flex;
    flex-direction: column;
    margin-bottom: 0.5rem;

    &.user-message {
      align-self: flex-end;
    background-color: #10b981;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }

    &.other-message {
      align-self: flex-start;
      background-color: #d1fae5;
      color: #1f2937;
      border-bottom-left-radius: 0.25rem;
    }

    &.system-message {
      align-self: center;
      background-color: #f3f4f6;
      color: #6b7280;
      font-size: 0.875rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 90%;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
      font-size: 0.8rem;
      
      .user-name {
        font-weight: 600;
      }
      
      .timestamp {
        color: #6b7280;
        font-size: 0.75rem;
      }
    }

    .message-content {
      word-wrap: break-word;
      width: 100%;
    }
  }

  .chat-input-container {
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .input-group {
    display: flex;
    gap: 0.5rem;

    input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    button {
      background-color: #10b981;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0 1.25rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;

      &:hover {
        background-color: #10b981;
      }
    }
  }

  @media (max-width: 768px) {
    .chat-container {
      flex-direction: column;
      height: 90%;
    }

    .sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #e5e7eb;
    }

    .main-chat {
      max-width: 100%;
      height: calc(100vh - 200px);
    }
  }
</style>

<script>
  // Parent user names
  const parentUsers = [
    "üë©‚Äçüë¶ Mar√≠a P.",
    "üë®‚Äçüëß Carlos M.",
    "üë©‚Äçüëß‚Äçüë¶ Laura S.",
    "üë®‚Äçüëß‚Äçüëß Antonio G.",
    "üë©‚Äçüë¶‚Äçüë¶ Elena R."
  ];

  // Prebuilt Q&A pairs
  const qaPairs = [
    {
      question: "Mi beb√© no duerme bien por la noche, ¬øalg√∫n consejo?",
      answer: "Lo que nos funcion√≥ fue establecer una rutina muy estricta antes de dormir: ba√±o, masaje, cuento y a la cama siempre a la misma hora."
    },
    {
      question: "¬øC√≥mo puedo ayudar a mi beb√© con los c√≥licos?",
      answer: "Para los c√≥licos, el masaje abdominal en el sentido de las agujas del reloj nos funcion√≥ genial. Tambi√©n probamos infusi√≥n de hinojo y mejor√≥ bastante."
    },
    {
      question: "Mi beb√© tiene 6 meses, ¬øc√≥mo empiezo con la alimentaci√≥n complementaria?",
      answer: "Nosotros empezamos con pur√© de zanahoria y le encant√≥. Las frutas las dejamos para el segundo mes. Recuerda esperar 3-4 d√≠as entre alimentos nuevos para detectar posibles alergias."
    },
    {
      question: "¬øQu√© hacer cuando mi beb√© tiene fiebre?",
      answer: "Cuando tuvo fiebre, alternamos paracetamol e ibuprofeno seg√∫n indicaci√≥n del pediatra, y ba√±os tibios. Si es menor de 3 meses, consulta inmediatamente al pediatra."
    },
    {
      question: "Mi hijo de 12 meses a√∫n no camina, ¬øes normal?",
      answer: "No te preocupes si va un poco retrasado en alg√∫n aspecto, cada ni√±o tiene su ritmo. Mi hijo no gate√≥ y pas√≥ directamente a caminar a los 14 meses. Si te preocupa, consulta con tu pediatra."
    },
    {
      question: "¬øC√≥mo manejar las rabietas de mi hijo de 2 a√±os?",
      answer: "Establecer l√≠mites claros desde el principio nos ha evitado muchas rabietas. El refuerzo positivo funciona much√≠simo mejor que los castigos en nuestra experiencia."
    },
    {
      question: "¬øCu√°ndo debo empezar a cepillar los dientes de mi beb√©?",
      answer: "Desde que aparece el primer diente. Puedes usar un dedal de silicona o un cepillo infantil muy suave con una cantidad m√≠nima de pasta especial para beb√©s."
    },
    {
      question: "Mi beb√© se despierta varias veces por la noche para comer, ¬øes normal?",
      answer: "A esa edad es normal que se despierte para comer. Intenta alimentarlo bien durante el d√≠a para que aguante m√°s por la noche. Con el tiempo ir√° espaciando las tomas nocturnas."
    },
    {
      question: "¬øC√≥mo s√© si mi beb√© come suficiente?",
      answer: "Si moja al menos 6 pa√±ales al d√≠a y gana peso regularmente seg√∫n las revisiones del pediatra, est√° comiendo lo suficiente."
    },
    {
      question: "¬øQu√© juguetes son mejores para estimular a mi beb√©?",
      answer: "Los juguetes Montessori ayudaron mucho en el desarrollo de la motricidad fina de mi hija. No necesitas muchos juguetes, pero s√≠ que sean apropiados para su edad y desarrollo."
    }
  ];

  // DOM elements
  const chatMessages = document.getElementById("chat-messages");
  const userInput = document.getElementById("user-input") as HTMLInputElement;
  const sendBtn = document.getElementById("send-btn");

  // Helper functions
  function getCurrentTime() {
    return "ahora";
  }

  function getRandomUser() {
    return parentUsers[Math.floor(Math.random() * parentUsers.length)];
  }

  function findAnswer(question: string) {
    const lowercaseQuestion = question.toLowerCase().trim();
    for (const pair of qaPairs) {
      if (
        lowercaseQuestion.includes(pair.question.toLowerCase()) ||
        pair.question.toLowerCase().includes(lowercaseQuestion)
      ) {
        return pair.answer;
      }
    }
    return "Cada ni√±o es un mundo, pero en mi experiencia lo m√°s importante es la paciencia y el amor. ¬øAlguien m√°s tiene experiencia con esto?";
  }

  function addMessage(content: string | null, type: string, userName: string | null = null) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${type}-message`;
    
    // Aplicar estilos base para todos los mensajes
    messageDiv.style.maxWidth = "85%";
    messageDiv.style.padding = "0.75rem 1rem";
    messageDiv.style.borderRadius = "1rem";
    messageDiv.style.display = "flex";
    messageDiv.style.flexDirection = "column";
    messageDiv.style.marginBottom = "0.5rem";
    
    // Aplicar estilos espec√≠ficos seg√∫n el tipo de mensaje
    if (type === "user") {
      messageDiv.style.alignSelf = "flex-end";
      messageDiv.style.backgroundColor = "#10b981";
      messageDiv.style.color = "white";
      messageDiv.style.borderBottomRightRadius = "0.25rem";
    } else if (type === "other") {
      messageDiv.style.alignSelf = "flex-start";
    messageDiv.style.backgroundColor = "#d1fae5";
      messageDiv.style.color = "#1f2937";
      messageDiv.style.borderBottomLeftRadius = "0.25rem";
    } else if (type === "system") {
      messageDiv.style.alignSelf = "center";
      messageDiv.style.backgroundColor = "#f3f4f6";
      messageDiv.style.color = "#6b7280";
      messageDiv.style.fontSize = "0.875rem";
      messageDiv.style.borderRadius = "0.5rem";
      messageDiv.style.textAlign = "center";
      messageDiv.style.maxWidth = "90%";
    }

    if (type !== "system") {
      const messageHeader = document.createElement("div");
      messageHeader.className = "message-header";
      
      // Estilos para el encabezado del mensaje
      messageHeader.style.display = "flex";
      messageHeader.style.justifyContent = type === "user" ? "flex-end" : "space-between";
      messageHeader.style.marginBottom = "0.25rem";
      messageHeader.style.fontSize = "0.8rem";
      
      const userNameSpan = document.createElement("span");
      userNameSpan.className = "user-name";
      userNameSpan.textContent = userName || "T√∫";
      
      // Estilos para el nombre de usuario
      userNameSpan.style.fontWeight = "600";
      
      messageHeader.appendChild(userNameSpan);
      
      // Solo agregar timestamp si NO es un mensaje de usuario
      if (type !== "user") {
        const timestamp = document.createElement("span");
        timestamp.className = "timestamp";
        timestamp.textContent = getCurrentTime();
        
        // Estilos para la marca de tiempo
        timestamp.style.color = "#6b7280";
        timestamp.style.fontSize = "0.75rem";
        
        messageHeader.appendChild(timestamp);
      }
      
      messageDiv.appendChild(messageHeader);
    }

    const messageContent = document.createElement("div");
    messageContent.className = "message-content";
    messageContent.textContent = content;
    
    // Estilos para el contenido del mensaje
    messageContent.style.wordWrap = "break-word";
    messageContent.style.width = "100%";
    
    messageDiv.appendChild(messageContent);
    
    chatMessages?.appendChild(messageDiv);

    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  }

  function simulateParentResponse(userMessage: string) {
    setTimeout(() => {
      const respondingUser = getRandomUser();
      const answer = findAnswer(userMessage);
      
      addMessage(answer, "other", respondingUser);
      
      // Sometimes add a second response from another parent
      if (Math.random() > 0.6) {
        setTimeout(() => {
          let secondUser = getRandomUser();
          // Make sure we get a different user
          while (secondUser === respondingUser) {
            secondUser = getRandomUser();
          }
          
          addMessage("Estoy de acuerdo con lo que dice " + respondingUser.split(" ")[1] + ". En nuestro caso tambi√©n probamos con..." + 
                    (Math.random() > 0.5 ? " Mucho √°nimo, ¬°esto mejora con el tiempo!" : " La clave es la paciencia y la constancia."), 
                    "other", secondUser);
        }, 1500 + Math.random() * 2000);
      }
    }, 800 + Math.random() * 1200);
  }

  // Event listeners
  sendBtn?.addEventListener("click", () => {
    if (userInput && userInput.value.trim() !== "") {
      const message = userInput.value;
      addMessage(message, "user");
      userInput.value = "";
      simulateParentResponse(message);
    }
  });

  userInput?.addEventListener("keypress", (e) => {
    if (e.key === "Enter" && userInput.value.trim() !== "") {
      const message = userInput.value;
      addMessage(message, "user");
      userInput.value = "";
      simulateParentResponse(message);
    }
  });
</script>